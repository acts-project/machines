name: Build images

on:
  - push

jobs:
  cc7_lcg95:
    runs-on: ubuntu-latest
    needs: base_images
    steps:
      - uses: actions/checkout@v1
      - name: Extract branch name
        shell: bash
        run: echo "::set-env name=BRANCH_NAME::$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//_/g')"
      - uses: acts-trk/Publish-Docker-Github-Action@master
        with:
          registry: gitlab-registry.cern.ch
          name: acts/machines/cc7_lcg95
          username: ${{ secrets.DOCKER_USERNAME  }}
          password: ${{ secrets.DOCKER_PASSWORD  }}
          context: cc7_lcg95
          buildargs: branch=${BRANCH_NAME}

  cc7_lcg96:
    runs-on: ubuntu-latest
    needs: base_images
    steps:
      - uses: actions/checkout@v1
      - name: Extract branch name
        shell: bash
        run: echo "::set-env name=BRANCH_NAME::$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//_/g')"
      - uses: acts-trk/Publish-Docker-Github-Action@master
        with:
          registry: gitlab-registry.cern.ch
          name: acts/machines/cc7_lcg96
          username: ${{ secrets.DOCKER_USERNAME  }}
          password: ${{ secrets.DOCKER_PASSWORD  }}
          context: cc7_lcg96
          buildargs: branch=${BRANCH_NAME}

  slc6_lcg95:
    runs-on: ubuntu-latest
    needs: base_images
    steps:
      - uses: actions/checkout@v1
      - name: Extract branch name
        shell: bash
        run: echo "::set-env name=BRANCH_NAME::$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//_/g')"
      - uses: acts-trk/Publish-Docker-Github-Action@master
        with:
          registry: gitlab-registry.cern.ch
          name: acts/machines/slc6_lcg95
          username: ${{ secrets.DOCKER_USERNAME  }}
          password: ${{ secrets.DOCKER_PASSWORD  }}
          context: slc6_lcg95
          buildargs: branch=${BRANCH_NAME}

  base_images:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dir:
          - cc7
          - slc6
          - ubuntu
          - ubuntu_llvm9
          # - check
          # - check_llvm8
          # - cc7-clang-tidy
    steps:
      - uses: actions/checkout@v2
      - uses: acts-trk/Publish-Docker-Github-Action@master
        with:
          registry: gitlab-registry.cern.ch
          name: acts/machines/${{ matrix.dir }}
          username: ${{ secrets.DOCKER_USERNAME  }}
          password: ${{ secrets.DOCKER_PASSWORD  }}
          context: ${{ matrix.dir }}

